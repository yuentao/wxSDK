# å¾®ä¿¡åˆ†äº« SDK

[![npm version](https://img.shields.io/npm/v/wxsdk-pure.svg)](https://www.npmjs.com/package/wxsdk-pure)
[![license](https://img.shields.io/npm/l/wxsdk-pure.svg)](https://github.com/yourusername/wxsdk-pure/blob/main/LICENSE)

ä¸€ä¸ªè½»é‡çº§ã€å¥å£®çš„å¾®ä¿¡åˆ†äº« SDK å°è£…ï¼Œæ”¯æŒæœ‹å‹åœˆåˆ†äº«ã€å¥½å‹åˆ†äº«å’Œå¾®ä¿¡å¼€æ”¾æ ‡ç­¾åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **ä¸€é”®åˆå§‹åŒ–**ï¼šç®€åŒ–å¾®ä¿¡åˆ†äº«é…ç½®æµç¨‹
- ğŸ”’ **å®‰å…¨å¯é **ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå‚æ•°æ ¡éªŒ
- âš¡ **æ™ºèƒ½åŠ è½½**ï¼šé¿å…é‡å¤åŠ è½½å¾®ä¿¡ SDK
- â±ï¸ **è¶…æ—¶æ§åˆ¶**ï¼šé˜²æ­¢åŠ è½½å¡æ­»
- ğŸ”„ **Promise API**ï¼šæ”¯æŒ async/await è°ƒç”¨
- ğŸ“± **å¾®ä¿¡å¼€æ”¾æ ‡ç­¾**ï¼šæ”¯æŒæœ€æ–°å¼€æ”¾æ ‡ç­¾åŠŸèƒ½

## å®‰è£…

```bash
npm install wxsdk-pure
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```javascript
import wxSDK from 'wxsdk-pure';

wxSDK({
  apiUrl: 'https://your-api.com/wx-signature',
  title: ['æœ‹å‹åœˆæ ‡é¢˜', 'å¥½å‹åˆ†äº«æ ‡é¢˜'],
  desc: 'åˆ†äº«æè¿°å†…å®¹',
  shareIcon: [
    'https://example.com/timeline-icon.jpg',
    'https://example.com/message-icon.jpg'
  ],
  debug: true
})
.then(wx => {
  console.log('å¾®ä¿¡ SDK åˆå§‹åŒ–æˆåŠŸ');
})
.catch(err => {
  console.error('åˆå§‹åŒ–å¤±è´¥:', err);
});
```

### é«˜çº§é…ç½®

```javascript
wxSDK({
  apiUrl: 'https://your-api.com/wx-signature',
  sdk: 'https://res.wx.qq.com/open/js/jweixin-1.6.0.js',
  title: 'é»˜è®¤æ ‡é¢˜',
  desc: 'åˆ†äº«æè¿°å†…å®¹',
  shareLinks: [
    'https://your-domain.com/timeline-url',
    'https://your-domain.com/message-url'
  ],
  jsApiList: ['chooseImage', 'previewImage'],
  openTagList: ['wx-open-launch-weapp'],
  timeout: 10000,
  callback: {
    ready: () => console.log('åˆ†äº«é…ç½®å°±ç»ª'),
    success: (type) => console.log(`${type} åˆ†äº«é…ç½®æˆåŠŸ`),
    error: (err) => console.error('åˆ†äº«é…ç½®å¤±è´¥', err)
  }
});
```

## é…ç½®é€‰é¡¹

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | æè¿° |
|------|------|---------|------|------|
| `apiUrl` | string | - | æ˜¯ | åç«¯ç­¾åæ¥å£åœ°å€ |
| `sdk` | string | `https://res.wx.qq.com/open/js/jweixin-1.6.0.js` | å¦ | å¾®ä¿¡ SDK URL |
| `title` | string \| string[] | `['åˆ†äº«è‡³æœ‹å‹åœˆ', 'åˆ†äº«è‡³å¥½å‹']` | å¦ | åˆ†äº«æ ‡é¢˜ |
| `desc` | string | `'ä¸‡äº‹çš†è™šï¼Œä¸‡ç‰©çš†å…'` | å¦ | åˆ†äº«æè¿° |
| `shareIcon` | string \| string[] | ç½‘ç«™å›¾æ ‡ | å¦ | åˆ†äº«å›¾æ ‡ URL |
| `shareLinks` | string \| string[] | å½“å‰é¡µé¢ URL | å¦ | åˆ†äº«é“¾æ¥ |
| `debug` | boolean | `false` | å¦ | å¯ç”¨è°ƒè¯•æ¨¡å¼ |
| `jsApiList` | string[] | `[]` | å¦ | å¾®ä¿¡ JS API åˆ—è¡¨ |
| `openTagList` | string[] | `[]` | å¦ | å¾®ä¿¡å¼€æ”¾æ ‡ç­¾åˆ—è¡¨ |
| `timeout` | number | `5000` | å¦ | SDK åŠ è½½è¶…æ—¶æ—¶é—´(ms) |
| `callback.ready` | function | - | å¦ | SDK å°±ç»ªå›è°ƒ |
| `callback.success` | function | - | å¦ | åˆ†äº«æˆåŠŸå›è°ƒ |
| `callback.error` | function | - | å¦ | é”™è¯¯å›è°ƒ |

## å›è°ƒå‡½æ•°

### `callback.ready()`
å½“å¾®ä¿¡ SDK åˆå§‹åŒ–å®Œæˆä¸”åˆ†äº«é…ç½®å°±ç»ªæ—¶è§¦å‘

### `callback.success(type)`
- `type`: `'timeline'` æˆ– `'message'`
å½“æœ‹å‹åœˆæˆ–å¥½å‹åˆ†äº«é…ç½®æˆåŠŸæ—¶è§¦å‘

### `callback.error(error)`
å½“å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ï¼Œå‚æ•°ä¸ºé”™è¯¯å¯¹è±¡

## æ³¨æ„äº‹é¡¹

1. **è·¨åŸŸé—®é¢˜**ï¼šç¡®ä¿åç«¯ç­¾åæ¥å£æ”¯æŒ CORS æˆ–ä½¿ç”¨ä»£ç†
2. **URL ä¸€è‡´æ€§**ï¼šç­¾å URL å¿…é¡»ä¸å½“å‰é¡µé¢ URL å®Œå…¨ä¸€è‡´ï¼ˆä¸å« hashï¼‰
3. **HTTPS**ï¼šå¾®ä¿¡è¦æ±‚æ‰€æœ‰é¡µé¢å¿…é¡»ä½¿ç”¨ HTTPS
4. **å¼€æ”¾æ ‡ç­¾**ï¼šä½¿ç”¨å¼€æ”¾æ ‡ç­¾éœ€åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·
5. **å›¾æ ‡å¤§å°**ï¼šå¾®ä¿¡åˆ†äº«å›¾æ ‡å»ºè®®å°ºå¯¸ 200Ã—200 åƒç´ 

## åç«¯æ¥å£è¦æ±‚

SDK éœ€è¦è°ƒç”¨åç«¯æ¥å£è·å–å¾®ä¿¡ç­¾åï¼Œæ¥å£åº”è¿”å›ä»¥ä¸‹æ ¼å¼çš„ JSON æ•°æ®ï¼š

```json
{
  "appId": "YOUR_WECHAT_APPID",
  "timestamp": 1620000000,
  "nonceStr": "RANDOM_STRING",
  "signature": "WEIXIN_SIGNATURE"
}
```

## åç«¯ Express å®ç°

### ç¯å¢ƒè¦æ±‚

1. Node.js 14+
2. Express 4.x
3. Axios 1.x

### å®‰è£…ä¾èµ–

```bash
npm install express axios
```

### å…·ä½“å®ç°

```javascript
const express = require('express');
const axios = require('axios');
const crypto = require('crypto');
const router = express.Router();

// ç¼“å­˜ access_token å’Œ ticket
let cacheToken = null;
let cacheTicket = null;
let tokenExpireTime = 0;
let ticketExpireTime = 0;

// å¾®ä¿¡åˆ†äº«ç­¾åæ¥å£
router.get('/wxShare', async (req, res) => {
  // å¾®ä¿¡å…¬ä¼—å·é…ç½®
  const appId = 'appId';
  const appsecret = 'appsecret';
  
  // è·å–å‰ç«¯ä¼ é€’çš„å½“å‰é¡µé¢ URL
  const { url } = req.query;
  
  // éªŒè¯å‚æ•°
  if (!url) {
    return res.status(400).json({
      code: 400,
      message: 'URLå‚æ•°ä¸èƒ½ä¸ºç©º'
    });
  }

  try {
    // æ£€æŸ¥å¹¶åˆ·æ–° access_token
    const now = Math.floor(Date.now() / 1000);
    if (!cacheToken || now >= tokenExpireTime) {
      const tokenResponse = await axios.get(
        `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appId}&secret=${appsecret}`
      );
      
      if (tokenResponse.data.errcode) {
        throw new Error(`è·å–access_tokenå¤±è´¥: ${tokenResponse.data.errmsg}`);
      }
      
      cacheToken = tokenResponse.data.access_token;
      // æå‰10åˆ†é’Ÿè¿‡æœŸ
      tokenExpireTime = now + tokenResponse.data.expires_in - 600;
    }

    // æ£€æŸ¥å¹¶åˆ·æ–° ticket
    if (!cacheTicket || now >= ticketExpireTime) {
      const ticketResponse = await axios.get(
        `https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=${cacheToken}&type=jsapi`
      );
      
      if (ticketResponse.data.errcode !== 0) {
        throw new Error(`è·å–ticketå¤±è´¥: ${ticketResponse.data.errmsg}`);
      }
      
      cacheTicket = ticketResponse.data.ticket;
      // æå‰10åˆ†é’Ÿè¿‡æœŸ
      ticketExpireTime = now + ticketResponse.data.expires_in - 600;
    }

    // ç”Ÿæˆç­¾å
    const nonceStr = generateNonceStr(16);
    const timestamp = Math.floor(Date.now() / 1000);
    
    const signature = generateSignature({
      jsapi_ticket: cacheTicket,
      noncestr: nonceStr,
      timestamp,
      url
    });

    res.json({
      appId,
      nonceStr,
      timestamp,
      signature
    });
    
  } catch (err) {
    console.error('å¾®ä¿¡åˆ†äº«ç­¾åé”™è¯¯:', err);
    
    // é‡ç½®ç¼“å­˜
    cacheToken = null;
    cacheTicket = null;
    
    res.status(500).json({
      code: 500,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      error: err.message
    });
  }
});

// ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
function generateNonceStr(length = 16) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let nonceStr = '';
  
  for (let i = 0; i < length; i++) {
    nonceStr += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  return nonceStr;
}

// ç”Ÿæˆç­¾å
function generateSignature(params) {
  const string = Object.keys(params)
    .sort()
    .map(key => `${key}=${params[key]}`)
    .join('&');
  
  return crypto.createHash('sha1').update(string).digest('hex');
}

module.exports = router;
```

### é”™è¯¯å“åº”

```json
{
  "code": 400,
  "message": "URLå‚æ•°ä¸èƒ½ä¸ºç©º"
}
```

```json
{
  "code": 500,
  "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
  "error": "è·å–access_tokenå¤±è´¥: invalid appid"
}
```

### å¯åŠ¨æœåŠ¡

åœ¨ `app.js` ä¸­é›†æˆè·¯ç”±ï¼š

```javascript
const express = require('express');
const wxShareRouter = require('./routes/wxShare');

const app = express();

// ä¸­é—´ä»¶
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// è·¯ç”±
app.use('/api', wxShareRouter);

// é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).send('æœåŠ¡å™¨é”™è¯¯');
});

// å¯åŠ¨æœåŠ¡å™¨
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);
});
```

## å¸¸è§é—®é¢˜

### 1. ç­¾åæ— æ•ˆ (invalid signature)

å¯èƒ½åŸå› ï¼š
- URL ä¸ä¸€è‡´ï¼ˆå‰ç«¯ä¼ å…¥çš„ URL å¿…é¡»ä¸å½“å‰é¡µé¢å®Œå…¨ä¸€è‡´ï¼‰
- æ—¶é—´æˆ³ä¸ä¸€è‡´ï¼ˆç¡®ä¿æœåŠ¡å™¨æ—¶é—´å‡†ç¡®ï¼‰
- ç­¾åç®—æ³•é”™è¯¯ï¼ˆä¸¥æ ¼æŒ‰ç…§å¾®ä¿¡æ–‡æ¡£å®ç°ï¼‰

è§£å†³æ–¹æ¡ˆï¼š
- éªŒè¯å‰ç«¯ä¼ å…¥çš„ URL æ˜¯å¦å»é™¤ hash éƒ¨åˆ†
- æ£€æŸ¥æœåŠ¡å™¨æ—¶é—´æ˜¯å¦åŒæ­¥
- ä½¿ç”¨å¾®ä¿¡å®˜æ–¹ç­¾åæ ¡éªŒå·¥å…·éªŒè¯